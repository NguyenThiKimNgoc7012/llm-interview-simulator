<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8" />
  <title>Chi ti·∫øt CV - {{ cv.personal_info.name if cv.personal_info.name else 'CV' }}</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/navbar.css') }}" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 0;
      border-bottom: 1px solid #ddd;
    }

    header .title {
      font-size: 24px;
      font-weight: 600;
    }

    header .buttons {
      display: flex;
      gap: 10px;
    }

    header .buttons button {
      font-size: 16px;
      padding: 10px 15px;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    header .buttons button:hover {
      background-color: #ff8c00;
      color: white;
    }

    .section-card {
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
      background-color: #f9f9f9;
    }

    .preview-box {
      border: 3px solid black;
      min-height: 90vh;
      padding: 20px;
      background: #fff;
    }

    .form-row {
      display: flex;
      gap: 16px;
      margin-bottom: 20px;
    }

    .form-column {
      flex: 1;
    }

    .form-column-full {
      flex: 1 100%;
    }

    .form-label {
      font-size: 14px;
      font-weight: 500;
      color: #333;
      display: block;
      margin-bottom: 8px;
    }

    .form-control {
      border-radius: 8px;
      border: 1px solid #e1e4e8;
      padding: 12px;
      font-size: 14px;
      outline: none;
      width: 100%;
      background-color: #f8f9fa;
    }

    .readonly-field {
      background-color: #e9ecef;
      cursor: default;
    }

    #preview_name {
      text-align: center;
      font-size: 24px;
      font-weight: bold;
      color: #ff4800;
      margin-bottom: 10px;
    }

    #preview_position,
    #preview_phone,
    #preview_email {
      display: inline-block;
      font-size: 16px;
      margin-right: 15px;
      text-align: center;
    }

    #preview_position::after,
    #preview_phone::after,
    #preview_email::after {
      content: " |";
      margin-left: 10px;
    }

    #preview_website::after {
      content: "";
    }

    #preview_container {
      text-align: center;
    }

    #preview_website {
      display: inline-block;
      max-width: 100%;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      word-wrap: break-word;
      width: 100%;
      text-align: center;
    }
  </style>
</head>

<body class="bg-light">
  <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm px-4">
    <div class="container-fluid">
      <a class="navbar-brand d-flex align-items-center" href="/"><img
          src="{{ url_for('static', filename='images/AI.png') }}" alt="Mona HR" class="logo-img" /></a>

      <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
        data-bs-target="#navbarSupportedContent"><span class="navbar-toggler-icon"></span></button>

      <div class="collapse navbar-collapse justify-content-end" id="navbarSupportedContent">
        <ul class="navbar-nav mb-2 mb-lg-0 gap-2">
          <li class="nav-item">
            <a class="nav-link" href="/form">B·∫Øt ƒë·∫ßu ph·ªèng v·∫•n</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/history">L·ªãch s·ª≠</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/cv_history">CV ƒë√£ l∆∞u</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/resume_form">T·∫°o CV m·ªõi</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Header with title and buttons -->
  <header class="container-fluid">
    <h1 style="margin-left:40px">Chi ti·∫øt CV - {{ cv.personal_info.name if cv.personal_info.name else 'CV' }}</h1>

    <div class="buttons">
      <button class="btn btn-outline-danger" onclick="downloadCurrentCV()"><i class="fas fa-download"></i> Download
        CV</button>
      <a href="/cv_history" class="btn btn-outline-secondary"><i class="fas fa-arrow-left"></i> Quay l·∫°i</a>
      <button class="btn btn-outline-primary" onclick="editCV()"><i class="fas fa-edit"></i> Ch·ªânh s·ª≠a</button>
    </div>
  </header>

  <div class="container-fluid mt-4">
    <div class="row">
      <!-- LEFT: Form (Read-only) -->
      <div class="col-md-6">
        <!-- Th√¥ng tin c∆° b·∫£n -->
        <div class="section-card">
          <h5>Th√¥ng tin c√° nh√¢n</h5>

          <!-- Name & Position Row -->
          <div class="form-row">
            <div class="form-column">
              <label class="form-label" for="name">T√™n ƒë·∫ßy ƒë·ªß</label>
              <input id="name" class="form-control readonly-field"
                value="{{ cv.personal_info.name if cv.personal_info.name else '' }}" readonly />
            </div>
            <div class="form-column">
              <label class="form-label" for="position">V·ªã tr√≠ ·ª©ng tuy·ªÉn</label>
              <input id="position" class="form-control readonly-field"
                value="{{ cv.personal_info.position if cv.personal_info.position else '' }}" readonly />
            </div>
          </div>

          <!-- Phone & Email Row -->
          <div class="form-row">
            <div class="form-column">
              <label class="form-label" for="phone">S·ªë ƒëi·ªán tho·∫°i</label>
              <input id="phone" class="form-control readonly-field"
                value="{{ cv.personal_info.phone if cv.personal_info.phone else '' }}" readonly />
            </div>
            <div class="form-column">
              <label class="form-label" for="email">Email</label>
              <input id="email" class="form-control readonly-field"
                value="{{ cv.personal_info.email if cv.personal_info.email else '' }}" readonly />
            </div>
          </div>

          <!-- Website Row -->
          <div class="form-row">
            <div class="form-column-full">
              <label class="form-label" for="website">Website</label>
              <input id="website" class="form-control readonly-field"
                value="{{ cv.personal_info.website if cv.personal_info.website else '' }}" readonly />
            </div>
          </div>

          <h5>üéØ Objective</h5>
          <textarea id="objective" class="form-control mt-2 readonly-field" rows="2"
            readonly>{{ cv.personal_info.objective if cv.personal_info.objective else '' }}</textarea>
        </div>

        <!-- Work Experience -->
        <div class="section-card">
          <h5>üíº Kinh nghi·ªám l√†m vi·ªác</h5>

          <div class="form-row">
            <div class="form-column">
              <label class="form-label" for="company">C√¥ng ty</label>
              <input id="company" class="form-control readonly-field"
                value="{{ cv.work_experience.company if cv.work_experience.company else '' }}" readonly />
            </div>
          </div>

          <div class="form-row">
            <div class="form-column">
              <label class="form-label" for="job_date">Ng√†y l√†m vi·ªác</label>
              <input id="job_date" class="form-control readonly-field"
                value="{{ cv.work_experience.job_date if cv.work_experience.job_date else '' }}" readonly />
            </div>
            <div class="form-column">
              <label class="form-label" for="job_title">Ch·ª©c danh</label>
              <input id="job_title" class="form-control readonly-field"
                value="{{ cv.work_experience.job_title if cv.work_experience.job_title else '' }}" readonly />
            </div>
          </div>

          <div class="form-column">
            <label class="form-label" for="job_desc_input">M√¥ t·∫£ c√¥ng vi·ªác</label>
            <textarea id="job_desc_input" class="form-control mt-2 readonly-field" rows="3"
              readonly>{{ cv.work_experience.job_description if cv.work_experience.job_description else '' }}</textarea>

            <label class="form-label mt-3" for="generated_experience">Kinh Nghi·ªám L√†m Vi·ªác (AI)</label>
            <textarea id="generated_experience" class="form-control mt-2 readonly-field" rows="3"
              readonly>{{ cv.work_experience.generated_experience if cv.work_experience.generated_experience else '' }}</textarea>
          </div>
        </div>

        <!-- Education -->
        <div class="section-card">
          <h5>üéì H·ªçc v·∫•n</h5>

          <div class="form-row">
            <div class="form-column">
              <label class="form-label" for="school">Tr∆∞·ªùng</label>
              <input id="school" class="form-control readonly-field"
                value="{{ cv.education.school if cv.education.school else '' }}" readonly />
            </div>
            <div class="form-column">
              <label class="form-label" for="edu_date">Ng√†y t·ªët nghi·ªáp</label>
              <input id="edu_date" class="form-control readonly-field"
                value="{{ cv.education.edu_date if cv.education.edu_date else '' }}" readonly />
            </div>
          </div>

          <div class="form-row">
            <div class="form-column">
              <label class="form-label" for="major">Chuy√™n ng√†nh</label>
              <input id="major" class="form-control readonly-field"
                value="{{ cv.education.major if cv.education.major else '' }}" readonly />
            </div>
            <div class="form-column">
              <label class="form-label" for="gpa">GPA</label>
              <input id="gpa" class="form-control readonly-field"
                value="{{ cv.education.gpa if cv.education.gpa else '' }}" readonly />
            </div>
          </div>
        </div>

        <!-- Projects -->
        <div class="section-card">
          <h5>üìÅ D·ª± √°n</h5>

          <div class="form-row">
            <div class="form-column">
              <label class="form-label" for="project_name">T√™n d·ª± √°n</label>
              <input id="project_name" class="form-control readonly-field"
                value="{{ cv.project.project_name if cv.project.project_name else '' }}" readonly />
            </div>
            <div class="form-column">
              <label class="form-label" for="project_date">Th·ªùi gian</label>
              <input id="project_date" class="form-control readonly-field"
                value="{{ cv.project.project_date if cv.project.project_date else '' }}" readonly />
            </div>
          </div>

          <div class="form-row">
            <div class="form-column-full">
              <label class="form-label" for="project_desc">M√¥ t·∫£ d·ª± √°n</label>
              <textarea id="project_desc" class="form-control mt-2 readonly-field" rows="2"
                readonly>{{ cv.project.project_desc if cv.project.project_desc else '' }}</textarea>
            </div>
          </div>
        </div>

        <!-- Skills -->
        <div class="section-card">
          <h5>üõ† K·ªπ nƒÉng</h5>

          <textarea class="form-control my-2 readonly-field" rows="2"
            readonly>{{ cv.skills if cv.skills else '' }}</textarea>

          <p class="mt-3 mb-1">
            <strong>Featured Skills</strong>
          </p>

          <div class="row">
            <div class="col-6 mb-2">
              <label class="form-label" for="Featured_Skills1">Featured Skill 1</label>
              <input id="Featured_Skills1" class="form-control readonly-field"
                value="{{ cv.featured_skills.skill1 if cv.featured_skills.skill1 else '' }}" readonly />
            </div>
            <div class="col-6 mb-2">
              <label class="form-label" for="Featured_Skills2">Featured Skill 2</label>
              <input id="Featured_Skills2" class="form-control readonly-field"
                value="{{ cv.featured_skills.skill2 if cv.featured_skills.skill2 else '' }}" readonly />
            </div>
          </div>
        </div>
      </div>

      <!-- RIGHT: Preview -->
      <div class="col-md-6">
        <div class="preview-box">
          <!-- Th√¥ng tin c∆° b·∫£n -->
          <div class="text-center text-primary" id="preview_name">{{ cv.personal_info.name if cv.personal_info.name else
            'T√™n ƒë·∫ßy ƒë·ªß...' }}</div>
          <div id="preview_position">{{ cv.personal_info.position if cv.personal_info.position else 'V·ªã tr√≠ ·ª©ng
            tuy·ªÉn...' }}</div>
          <div id="preview_phone">{{ cv.personal_info.phone if cv.personal_info.phone else 'S·ªë ƒëi·ªán tho·∫°i...' }}</div>
          <div id="preview_email">{{ cv.personal_info.email if cv.personal_info.email else 'Email...' }}</div>
          <div id="preview_website">{{ cv.personal_info.website if cv.personal_info.website else 'Website...' }}</div>

          <!-- Objective -->
          <hr class="line-divider" />
          <p><strong>OBJECTIVE</strong></p>
          <div id="preview_objective1">{{ cv.personal_info.objective if cv.personal_info.objective else 'M·ª•c ti√™u ngh·ªÅ
            nghi·ªáp...' }}</div>

          <hr class="line-divider" />
          <p><strong>WORK EXPERIENCE</strong></p>
          <div id="preview_work_experience">
            <div id="preview_company">{{ cv.work_experience.company if cv.work_experience.company else 'C√¥ng ty...' }}
            </div>
            <div id="preview_job_date">{{ cv.work_experience.job_date if cv.work_experience.job_date else 'Ng√†y l√†m
              vi·ªác...' }}</div>
            <div id="preview_job_title">{{ cv.work_experience.job_title if cv.work_experience.job_title else 'Ch·ª©c
              danh...' }}</div>
            <div id="preview_generated_experience">{{ cv.work_experience.generated_experience if
              cv.work_experience.generated_experience else 'Kinh nghi·ªám l√†m vi·ªác...' }}</div>
          </div>

          <hr class="line-divider" />
          <p><strong>PROJECT</strong></p>
          <div id="preview_project">
            <div id="preview_project_name">{{ cv.project.project_name if cv.project.project_name else 'T√™n d·ª± √°n...' }}
            </div>
            <div id="preview_project_date">{{ cv.project.project_date if cv.project.project_date else 'Th·ªùi gian...' }}
            </div>
            <div id="preview_project_desc">{{ cv.project.project_desc if cv.project.project_desc else 'M√¥ t·∫£ d·ª± √°n...'
              }}</div>
          </div>

          <hr class="line-divider" />
          <p><strong>EDUCATION</strong></p>
          <div id="preview_education">
            <div id="preview_school">{{ cv.education.school if cv.education.school else 'Tr∆∞·ªùng h·ªçc...' }}</div>
            <div id="preview_edu_date">{{ cv.education.edu_date if cv.education.edu_date else 'Ng√†y t·ªët nghi·ªáp...' }}
            </div>
            <div id="preview_major">{{ cv.education.major if cv.education.major else 'Chuy√™n ng√†nh...' }}</div>
            <div id="preview_gpa">{{ cv.education.gpa if cv.education.gpa else 'GPA...' }}</div>
          </div>

          <hr class="line-divider" />
          <p><strong>SKILLS</strong></p>
          <div id="preview_skills">{{ cv.skills if cv.skills else 'K·ªπ nƒÉng...' }}</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 10000">
    <div id="toastMsg" class="toast align-items-center text-white bg-success border-0" role="alert">
      <div class="d-flex">
        <div class="toast-body" id="toastBody">CV ƒë√£ ƒë∆∞·ª£c t·∫£i xu·ªëng th√†nh c√¥ng!</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Download CV hi·ªán t·∫°i
    function downloadCurrentCV() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      // L·∫•y d·ªØ li·ªáu t·ª´ c√°c tr∆∞·ªùng readonly
      const name = document.getElementById("name").value;
      const position = document.getElementById("position").value;
      const phone = document.getElementById("phone").value;
      const email = document.getElementById("email").value;
      const website = document.getElementById("website").value;
      const objective = document.getElementById("objective").value;
      const company = document.getElementById("company").value;
      const job_date = document.getElementById("job_date").value;
      const job_title = document.getElementById("job_title").value;
      const generated_experience = document.getElementById("generated_experience").value;
      const school = document.getElementById("school").value;
      const edu_date = document.getElementById("edu_date").value;
      const major = document.getElementById("major").value;
      const gpa = document.getElementById("gpa").value;
      const project_name = document.getElementById("project_name").value;
      const project_date = document.getElementById("project_date").value;
      const project_desc = document.getElementById("project_desc").value;
      const skills = document.querySelector('.section-card:last-child textarea').value;
      const featured_skill1 = document.getElementById("Featured_Skills1").value;
      const featured_skill2 = document.getElementById("Featured_Skills2").value;

      let y = 15;
      doc.setFontSize(18);
      doc.text(name, 105, y, { align: 'center' });
      y += 10;
      doc.setFontSize(12);
      doc.text(`${position} | ${phone} | ${email}${website ? ' | ' + website : ''}`, 105, y, { align: 'center' });
      y += 10;

      // Objective
      if (objective) {
        doc.setFontSize(14);
        doc.text('OBJECTIVE', 10, y);
        y += 7;
        doc.setFontSize(11);
        y = addMultiline(doc, objective, 10, y, 180);
        y += 5;
      }

      // Work Experience
      if (company || job_title) {
        doc.setFontSize(14);
        doc.text('WORK EXPERIENCE', 10, y);
        y += 7;
        doc.setFontSize(11);
        if (company) { doc.text(`Company: ${company}`, 10, y); y += 6; }
        if (job_title) { doc.text(`Position: ${job_title}`, 10, y); y += 6; }
        if (job_date) { doc.text(`Duration: ${job_date}`, 10, y); y += 6; }
        if (generated_experience) { y = addMultiline(doc, `Description: ${generated_experience}`, 10, y, 180); }
        y += 5;
      }

      // Education
      if (school || major) {
        doc.setFontSize(14);
        doc.text('EDUCATION', 10, y);
        y += 7;
        doc.setFontSize(11);
        if (school) { doc.text(`School: ${school}`, 10, y); y += 6; }
        if (major) { doc.text(`Major: ${major}`, 10, y); y += 6; }
        if (edu_date) { doc.text(`Graduation: ${edu_date}`, 10, y); y += 6; }
        if (gpa) { doc.text(`GPA: ${gpa}`, 10, y); y += 6; }
        y += 5;
      }

      // Projects
      if (project_name) {
        doc.setFontSize(14);
        doc.text('PROJECTS', 10, y);
        y += 7;
        doc.setFontSize(11);
        doc.text(`Project: ${project_name}`, 10, y); y += 6;
        if (project_date) { doc.text(`Duration: ${project_date}`, 10, y); y += 6; }
        if (project_desc) { y = addMultiline(doc, `Description: ${project_desc}`, 10, y, 180); }
        y += 5;
      }

      // Skills
      if (skills || featured_skill1 || featured_skill2) {
        doc.setFontSize(14);
        doc.text('SKILLS', 10, y);
        y += 7;
        doc.setFontSize(11);
        if (skills) { y = addMultiline(doc, skills, 10, y, 180); }
        if (featured_skill1) { doc.text(`Featured Skill 1: ${featured_skill1}`, 10, y); y += 6; }
        if (featured_skill2) { doc.text(`Featured Skill 2: ${featured_skill2}`, 10, y); y += 6; }
      }

      doc.save(`CV_${name.replace(/\s+/g, '_')}.pdf`);

      // Hi·ªÉn th·ªã toast
      const toast = new bootstrap.Toast(document.getElementById('toastMsg'));
      toast.show();
    }

    // Helper function ƒë·ªÉ xu·ªëng d√≤ng t·ª± ƒë·ªông
    function addMultiline(doc, text, x, y, maxWidth) {
      const lines = doc.splitTextToSize(text, maxWidth);
      lines.forEach(line => {
        doc.text(line, x, y);
        y += 6;
      });
      return y;
    }

    // Chuy·ªÉn sang ch·∫ø ƒë·ªô ch·ªânh s·ª≠a
    function editCV() {
      window.location.href = '/resume_form?edit={{ cv._id }}';
    }
  </script>
</body>

</html>